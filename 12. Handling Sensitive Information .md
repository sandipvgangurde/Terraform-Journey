# 🔐 **SOP: Handling Sensitive Information in Terraform (with Terraform Plan Outputs)**

---

## 🎯 **Objective**

Learn how Terraform manages **secrets (passwords, tokens, keys, etc.)**, what mistakes to avoid, and how to correctly secure them.
Every example now includes **Terraform CLI plan output** to show what happens in real life.

---

## 🧩 **1️⃣ Base Code – Plain Text (❌ Insecure)**

```hcl
resource "local_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}
```

### 🧠 **Explanation**

| 🔍 Aspect        | 💬 Description                                               |
| ---------------- | ------------------------------------------------------------ |
| **What it does** | Creates a local file `password.txt` with the secret.         |
| **Problem**      | Secret exposed in CLI output, logs, and `terraform.tfstate`. |
| **Risk Level**   | 🔴 **Critical** — never do this.                             |

---

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = "supersecretpassw0rd"
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

💣 **Result:** Password fully visible in the CLI and logs.
This is a **total security failure**.

---

## 🧩 **2️⃣ Using Variables (⚠️ Slightly Better, Still Unsafe)**

```hcl
variable "password" {
  default = "supersecretpassw0rd"
}

resource "local_file" "foo" {
  content  = var.password
  filename = "password.txt"
}
```

### 🧠 **Explanation**

| 🔍 Aspect       | 💬 Description                                 |
| --------------- | ---------------------------------------------- |
| **Improvement** | Abstracted with a variable.                    |
| **Problem**     | Terraform still prints the value.              |
| **Risk Level**  | 🟠 **Medium** — still exposed in plan & state. |

---

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = "supersecretpassw0rd"
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

⚠️ **Still exposed.**
Terraform does not hide it because the variable is not sensitive.

---

## 🧩 **3️⃣ Marking Variable as Sensitive (✅ Secure Practice)**

```hcl
variable "password" {
  default   = "supersecretpassw0rd"
  sensitive = true
}

resource "local_file" "foo" {
  content  = var.password
  filename = "password.txt"
}
```

### 🧠 **Explanation**

| 🔍 Aspect          | 💬 Description                           |
| ------------------ | ---------------------------------------- |
| **Sensitive flag** | Terraform hides value in CLI output.     |
| **State file**     | Stores internally, flagged as sensitive. |
| **Risk Level**     | 🟢 **Good security practice.**           |

---

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = (sensitive value)
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

✅ **Result:**
Secret hidden as `(sensitive value)`. Terraform prevents it from appearing in logs.

---

## 🧩 **4️⃣ Using Local Sensitive File Resource (🧱 Most Secure Local Option)**

```hcl
resource "local_sensitive_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}
```

### 🧠 **Explanation**

| 🔍 Aspect      | 💬 Description                                                |
| -------------- | ------------------------------------------------------------- |
| **Type**       | `local_sensitive_file` masks sensitive content automatically. |
| **CLI Output** | Terraform never shows file content.                           |
| **Risk Level** | 🟢 **Highly secure.**                                         |

---

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_sensitive_file.foo will be created
  + resource "local_sensitive_file" "foo" {
      + content              = (sensitive value)
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

✅ **Safe output** — Terraform completely hides sensitive information.

---

## 🧩 **5️⃣ Using Output Values (⚠️ Dangerous Unless Marked Sensitive)**

### ❌ **Insecure Example**

```hcl
resource "local_sensitive_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}

output "pass" {
  value = local_sensitive_file.foo.content
}
```

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Outputs:

pass = "supersecretpassw0rd"
```

🚨 **Disaster:** Output prints the full secret on screen.

---

### ✅ **Secure Version**

```hcl
output "pass" {
  value     = local_sensitive_file.foo.content
  sensitive = true
}
```

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

Outputs:

pass = (sensitive value)
```

✅ Secret hidden safely — now `(sensitive value)` appears instead of plaintext.

---

## 🧩 **6️⃣ Example: AWS RDS Instance (🔒 Real Cloud Case)**

```hcl
resource "aws_db_instance" "default" {
  allocated_storage    = 10
  db_name              = "mydb"
  engine               = "mysql"
  engine_version       = "8.0"
  instance_class       = "db.t3.micro"
  username             = "foo"
  password             = "foobarbaz"
  parameter_group_name = "default.mysql8.0"
  skip_final_snapshot  = true
}
```

### 🧾 **Terraform Plan Output (Insecure)**

```bash
+ password = "foobarbaz"
```

🔴 **Password visible** — this is a compliance violation.

---

### ✅ **Secure Version**

```hcl
variable "db_password" {
  description = "Database master password"
  sensitive   = true
}

resource "aws_db_instance" "default" {
  allocated_storage    = 10
  db_name              = "mydb"
  engine               = "mysql"
  engine_version       = "8.0"
  instance_class       = "db.t3.micro"
  username             = "foo"
  password             = var.db_password
  parameter_group_name = "default.mysql8.0"
  skip_final_snapshot  = true
}
```

### 🧾 **Terraform Plan Output (Secure)**

```bash
$ terraform plan

  # aws_db_instance.default will be created
  + resource "aws_db_instance" "default" {
      + db_name   = "mydb"
      + password  = (sensitive value)
      ...
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

✅ **Now password is hidden**, safe for teams and automation logs.

---

## 🧮 **Visibility Summary Table**

| 🧩 Scenario              | 🧾 CLI Output | 💾 State File    | 🔒 Best Practice |
| ------------------------ | ------------- | ---------------- | ---------------- |
| Plaintext in resource    | ✅ Visible     | ✅ Visible        | ❌ Never do this  |
| Variable (not sensitive) | ✅ Visible     | ✅ Visible        | ⚠️ Risky         |
| Variable (sensitive)     | ❌ Hidden      | ⚠️ Stored masked | ✅ Recommended    |
| `local_sensitive_file`   | ❌ Hidden      | ❌ Hidden         | ✅ Secure         |
| Output (not sensitive)   | ✅ Visible     | ✅ Visible        | ❌ Avoid          |
| Output (sensitive)       | ❌ Hidden      | ✅ Masked         | ✅ Safe           |
| RDS hardcoded password   | ✅ Visible     | ✅ Visible        | ❌ Never          |
| RDS password variable    | ❌ Hidden      | ⚠️ Masked        | ✅ Best practice  |

---

## 🧠 **Additional Security Tips**

| ⚙️ Practice                                | 💡 Why It Matters                 |
| ------------------------------------------ | --------------------------------- |
| 🔒 **Mark outputs as sensitive**           | Prevents log exposure             |
| 🌍 **Use environment variables**           | `export TF_VAR_password="secret"` |
| 🧰 **Use Vault/Secret Manager**            | Avoid storing secrets in `.tf`    |
| 🔐 **Restrict access to state files**      | They contain secret references    |
| ☁️ **Encrypt backends (S3, GCS, etc.)**    | Protects state at rest            |
| 🧹 **Never commit `.tfstate` / `.tfvars`** | They may expose secrets           |

---

## 🚀 **Full Secure Setup Example**

```hcl
variable "password" {
  description = "Secure password for local file"
  sensitive   = true
}

resource "local_sensitive_file" "foo" {
  content  = var.password
  filename = "password.txt"
}

output "pass" {
  value     = local_sensitive_file.foo.content
  sensitive = true
}
```

### 🧾 **Terraform Plan Output**

```bash
$ terraform plan

  # local_sensitive_file.foo will be created
  + resource "local_sensitive_file" "foo" {
      + content  = (sensitive value)
      + filename = "password.txt"
      + id       = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Outputs:

pass = (sensitive value)
```

✅ **Final Results**

| ✅ Outcome                       | 💬 Description                          |
| ------------------------------- | --------------------------------------- |
| 🔒 Password hidden in CLI       | `(sensitive value)` replaces real value |
| 💾 Password not exposed in logs | Safe in automation pipelines            |
| 📁 File created locally         | Secret written securely                 |
| 🧠 Security hygiene maintained  | Terraform best-practice compliant       |

---
