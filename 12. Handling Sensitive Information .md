# ğŸ” **SOP: Handling Sensitive Information in Terraform (with Terraform Plan Outputs)**

---

## ğŸ¯ **Objective**

Learn how Terraform manages **secrets (passwords, tokens, keys, etc.)**, what mistakes to avoid, and how to correctly secure them.
Every example now includes **Terraform CLI plan output** to show what happens in real life.

---

## ğŸ§© **1ï¸âƒ£ Base Code â€“ Plain Text (âŒ Insecure)**

```hcl
resource "local_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}
```

### ğŸ§  **Explanation**

| ğŸ” Aspect        | ğŸ’¬ Description                                               |
| ---------------- | ------------------------------------------------------------ |
| **What it does** | Creates a local file `password.txt` with the secret.         |
| **Problem**      | Secret exposed in CLI output, logs, and `terraform.tfstate`. |
| **Risk Level**   | ğŸ”´ **Critical** â€” never do this.                             |

---

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = "supersecretpassw0rd"
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

ğŸ’£ **Result:** Password fully visible in the CLI and logs.
This is a **total security failure**.

---

## ğŸ§© **2ï¸âƒ£ Using Variables (âš ï¸ Slightly Better, Still Unsafe)**

```hcl
variable "password" {
  default = "supersecretpassw0rd"
}

resource "local_file" "foo" {
  content  = var.password
  filename = "password.txt"
}
```

### ğŸ§  **Explanation**

| ğŸ” Aspect       | ğŸ’¬ Description                                 |
| --------------- | ---------------------------------------------- |
| **Improvement** | Abstracted with a variable.                    |
| **Problem**     | Terraform still prints the value.              |
| **Risk Level**  | ğŸŸ  **Medium** â€” still exposed in plan & state. |

---

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = "supersecretpassw0rd"
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

âš ï¸ **Still exposed.**
Terraform does not hide it because the variable is not sensitive.

---

## ğŸ§© **3ï¸âƒ£ Marking Variable as Sensitive (âœ… Secure Practice)**

```hcl
variable "password" {
  default   = "supersecretpassw0rd"
  sensitive = true
}

resource "local_file" "foo" {
  content  = var.password
  filename = "password.txt"
}
```

### ğŸ§  **Explanation**

| ğŸ” Aspect          | ğŸ’¬ Description                           |
| ------------------ | ---------------------------------------- |
| **Sensitive flag** | Terraform hides value in CLI output.     |
| **State file**     | Stores internally, flagged as sensitive. |
| **Risk Level**     | ğŸŸ¢ **Good security practice.**           |

---

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_file.foo will be created
  + resource "local_file" "foo" {
      + content              = (sensitive value)
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

âœ… **Result:**
Secret hidden as `(sensitive value)`. Terraform prevents it from appearing in logs.

---

## ğŸ§© **4ï¸âƒ£ Using Local Sensitive File Resource (ğŸ§± Most Secure Local Option)**

```hcl
resource "local_sensitive_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}
```

### ğŸ§  **Explanation**

| ğŸ” Aspect      | ğŸ’¬ Description                                                |
| -------------- | ------------------------------------------------------------- |
| **Type**       | `local_sensitive_file` masks sensitive content automatically. |
| **CLI Output** | Terraform never shows file content.                           |
| **Risk Level** | ğŸŸ¢ **Highly secure.**                                         |

---

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Terraform will perform the following actions:

  # local_sensitive_file.foo will be created
  + resource "local_sensitive_file" "foo" {
      + content              = (sensitive value)
      + filename             = "password.txt"
      + id                   = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

âœ… **Safe output** â€” Terraform completely hides sensitive information.

---

## ğŸ§© **5ï¸âƒ£ Using Output Values (âš ï¸ Dangerous Unless Marked Sensitive)**

### âŒ **Insecure Example**

```hcl
resource "local_sensitive_file" "foo" {
  content  = "supersecretpassw0rd"
  filename = "password.txt"
}

output "pass" {
  value = local_sensitive_file.foo.content
}
```

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Outputs:

pass = "supersecretpassw0rd"
```

ğŸš¨ **Disaster:** Output prints the full secret on screen.

---

### âœ… **Secure Version**

```hcl
output "pass" {
  value     = local_sensitive_file.foo.content
  sensitive = true
}
```

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

Outputs:

pass = (sensitive value)
```

âœ… Secret hidden safely â€” now `(sensitive value)` appears instead of plaintext.

---

## ğŸ§© **6ï¸âƒ£ Example: AWS RDS Instance (ğŸ”’ Real Cloud Case)**

```hcl
resource "aws_db_instance" "default" {
  allocated_storage    = 10
  db_name              = "mydb"
  engine               = "mysql"
  engine_version       = "8.0"
  instance_class       = "db.t3.micro"
  username             = "foo"
  password             = "foobarbaz"
  parameter_group_name = "default.mysql8.0"
  skip_final_snapshot  = true
}
```

### ğŸ§¾ **Terraform Plan Output (Insecure)**

```bash
+ password = "foobarbaz"
```

ğŸ”´ **Password visible** â€” this is a compliance violation.

---

### âœ… **Secure Version**

```hcl
variable "db_password" {
  description = "Database master password"
  sensitive   = true
}

resource "aws_db_instance" "default" {
  allocated_storage    = 10
  db_name              = "mydb"
  engine               = "mysql"
  engine_version       = "8.0"
  instance_class       = "db.t3.micro"
  username             = "foo"
  password             = var.db_password
  parameter_group_name = "default.mysql8.0"
  skip_final_snapshot  = true
}
```

### ğŸ§¾ **Terraform Plan Output (Secure)**

```bash
$ terraform plan

  # aws_db_instance.default will be created
  + resource "aws_db_instance" "default" {
      + db_name   = "mydb"
      + password  = (sensitive value)
      ...
    }

Plan: 1 to add, 0 to change, 0 to destroy.
```

âœ… **Now password is hidden**, safe for teams and automation logs.

---

## ğŸ§® **Visibility Summary Table**

| ğŸ§© Scenario              | ğŸ§¾ CLI Output | ğŸ’¾ State File    | ğŸ”’ Best Practice |
| ------------------------ | ------------- | ---------------- | ---------------- |
| Plaintext in resource    | âœ… Visible     | âœ… Visible        | âŒ Never do this  |
| Variable (not sensitive) | âœ… Visible     | âœ… Visible        | âš ï¸ Risky         |
| Variable (sensitive)     | âŒ Hidden      | âš ï¸ Stored masked | âœ… Recommended    |
| `local_sensitive_file`   | âŒ Hidden      | âŒ Hidden         | âœ… Secure         |
| Output (not sensitive)   | âœ… Visible     | âœ… Visible        | âŒ Avoid          |
| Output (sensitive)       | âŒ Hidden      | âœ… Masked         | âœ… Safe           |
| RDS hardcoded password   | âœ… Visible     | âœ… Visible        | âŒ Never          |
| RDS password variable    | âŒ Hidden      | âš ï¸ Masked        | âœ… Best practice  |

---

## ğŸ§  **Additional Security Tips**

| âš™ï¸ Practice                                | ğŸ’¡ Why It Matters                 |
| ------------------------------------------ | --------------------------------- |
| ğŸ”’ **Mark outputs as sensitive**           | Prevents log exposure             |
| ğŸŒ **Use environment variables**           | `export TF_VAR_password="secret"` |
| ğŸ§° **Use Vault/Secret Manager**            | Avoid storing secrets in `.tf`    |
| ğŸ” **Restrict access to state files**      | They contain secret references    |
| â˜ï¸ **Encrypt backends (S3, GCS, etc.)**    | Protects state at rest            |
| ğŸ§¹ **Never commit `.tfstate` / `.tfvars`** | They may expose secrets           |

---

## ğŸš€ **Full Secure Setup Example**

```hcl
variable "password" {
  description = "Secure password for local file"
  sensitive   = true
}

resource "local_sensitive_file" "foo" {
  content  = var.password
  filename = "password.txt"
}

output "pass" {
  value     = local_sensitive_file.foo.content
  sensitive = true
}
```

### ğŸ§¾ **Terraform Plan Output**

```bash
$ terraform plan

  # local_sensitive_file.foo will be created
  + resource "local_sensitive_file" "foo" {
      + content  = (sensitive value)
      + filename = "password.txt"
      + id       = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Outputs:

pass = (sensitive value)
```

âœ… **Final Results**

| âœ… Outcome                       | ğŸ’¬ Description                          |
| ------------------------------- | --------------------------------------- |
| ğŸ”’ Password hidden in CLI       | `(sensitive value)` replaces real value |
| ğŸ’¾ Password not exposed in logs | Safe in automation pipelines            |
| ğŸ“ File created locally         | Secret written securely                 |
| ğŸ§  Security hygiene maintained  | Terraform best-practice compliant       |

---
