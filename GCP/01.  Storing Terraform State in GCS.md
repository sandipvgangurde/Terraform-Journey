# 🧱 **SOP: Storing Terraform State in GCS and Creating a VM**

---

## 🧩 **PART 1 — Create the GCS Bucket for Terraform State**

---

### 🎯 **Objective**

To create a **Google Cloud Storage (GCS)** bucket that will securely store Terraform’s state file, enabling centralized, versioned, and recoverable infrastructure management.

---

### 🧠 **Why Store Terraform State Remotely?**

| 🔍 Aspect             | 💡 Description                                                                                  | 🚀 Benefit                                                  |
| :-------------------- | :---------------------------------------------------------------------------------------------- | :---------------------------------------------------------- |
| **Collaboration**     | When multiple engineers use Terraform, a shared remote state prevents conflicts and overwrites. | Team members work safely on shared infra.                   |
| **Backup & Recovery** | GCS provides object versioning and replication.                                                 | Accidental changes or corruption can be rolled back easily. |
| **Consistency**       | Remote state ensures everyone reads the same infra data.                                        | Avoids "drift" between local and real-world infra.          |
| **Security**          | GCS supports IAM, encryption, and access control.                                               | Protects sensitive resource data (IPs, credentials).        |
| **Automation Ready**  | CI/CD pipelines and Terraform Cloud integrations need remote state.                             | Enables seamless automation and remote execution.           |

---

### 🧱 **Terraform Configuration (main.tf)**

```hcl
# -----------------------------------
# 1️⃣ Provider Configuration
# -----------------------------------
provider "google" {
  project = "your-gcp-project-id"   # 🔹 Replace with your actual project ID
  region  = "asia-south1"
}

# -----------------------------------
# 2️⃣ Create GCS Bucket for Terraform State
# -----------------------------------
resource "google_storage_bucket" "tf_state_bucket" {
  name          = "my-tf-state-bucket-12345"   # 🔹 Must be globally unique
  location      = "ASIA-SOUTH1"
  force_destroy = true                         # Delete bucket even with objects

  versioning {
    enabled = true                             # 🧠 Keep history of state versions
  }

  lifecycle_rule {
    action {
      type = "Delete"
    }
    condition {
      age = 365                                # Delete objects older than 1 year
    }
  }
}
```

---

### ⚙️ **Execution Steps**

| 🪜 Step | 🧠 Action                | 💡 Description                                           |
| :------ | :----------------------- | :------------------------------------------------------- |
| 1️⃣     | **Save the file**        | Save the above code as `main.tf`                         |
| 2️⃣     | **Initialize Terraform** | Run `terraform init` — downloads the GCP provider plugin |
| 3️⃣     | **Apply configuration**  | Run `terraform apply -auto-approve`                      |
| 4️⃣     | **Verify bucket**        | Check: `gsutil ls` — ensure the bucket is created        |

---

### ✅ **Expected Result**

A **GCS bucket** named `my-tf-state-bucket-12345` is created in the `asia-south1` region with **versioning enabled**, ready to store Terraform state securely and support future automation or collaboration.

---

---

## ⚙️ **PART 2 — Initialize Terraform Backend (GCS) and Create a VM**

---

### 🎯 **Objective**

To configure Terraform to **use the GCS bucket** created in Part 1 as a **remote backend**, and to deploy a **Compute Engine VM** using that backend.

---

### 🧱 **Terraform Configuration (main.tf)**

```hcl
# -----------------------------------
# 1️⃣ Provider Configuration
# -----------------------------------
provider "google" {
  project = "your-gcp-project-id"
  region  = "asia-south1"
}

# -----------------------------------
# 2️⃣ Remote Backend Configuration
# -----------------------------------
terraform {
  backend "gcs" {
    bucket = "my-tf-state-bucket-12345"        # 🔹 Use same bucket from Part 1
    prefix = "terraform/state"                 # Folder path in the bucket
  }
}

# -----------------------------------
# 3️⃣ Create a Compute Engine VM
# -----------------------------------
resource "google_compute_instance" "vm_instance" {
  name         = "vm-sandeep-1"
  machine_type = "e2-micro"
  zone         = "asia-south1-a"

  boot_disk {
    initialize_params {
      image = "ubuntu-os-cloud/ubuntu-2204-lts"
    }
  }

  network_interface {
    network = "default"
    access_config {}  # Enables external IP
  }

  metadata = {
    ssh-keys = "sandeep:${file("~/.ssh/id_rsa.pub")}"
  }

  tags = ["terraform-demo"]
}
```

---

### ⚙️ **Execution Steps**

| 🪜 Step | 🧠 Action                | 💡 Description                                                     |
| :------ | :----------------------- | :----------------------------------------------------------------- |
| 1️⃣     | **Ensure bucket exists** | The bucket from **Part 1** must already exist                      |
| 2️⃣     | **Initialize backend**   | Run: `terraform init -migrate-state` to connect to GCS             |
| 3️⃣     | **Apply Terraform**      | Run: `terraform apply -auto-approve` to create VM                  |
| 4️⃣     | **Verify backend**       | Run: `gsutil ls -r gs://my-tf-state-bucket-12345/terraform/state/` |
| 5️⃣     | **Verify VM**            | Run: `gcloud compute instances list`                               |

---

### ✅ **Expected Result**

* Terraform **state file** is stored remotely in the **GCS bucket**.
* A **Compute Engine VM** is created successfully in `asia-south1-a`.
* Future `terraform apply` and `terraform destroy` operations automatically use the **remote state**.

---

### 🧠 **Key Notes**

| ⚙️ Key Point                   | 🧩 Explanation                                                                                                 |
| :----------------------------- | :------------------------------------------------------------------------------------------------------------- |
| **Static Backend Config**      | Backend cannot use variables or references — it must have hardcoded values.                                    |
| **Re-initialization Required** | Every time backend configuration changes, rerun `terraform init`.                                              |
| **State Protection**           | GCS versioning ensures rollback in case of accidental state corruption.                                        |
| **Access Control**             | Terraform user or service account needs roles: <br> - `roles/storage.admin` <br> - `roles/storage.objectAdmin` |

---

### 🧹 **Cleanup**

When done testing, destroy everything:

```bash
terraform destroy -auto-approve
```

Because `force_destroy = true`, Terraform can delete the bucket even if it still contains files.

---

## 🏁 **Final Outcome Summary**

| ✅ Component              | 🧱 Description                                          |
| :----------------------- | :------------------------------------------------------ |
| 🪣 **GCS Bucket**        | Centralized remote backend for Terraform state          |
| 🧠 **Versioning**        | Tracks and protects state changes                       |
| ⚙️ **Remote Backend**    | Enables collaboration and automation                    |
| 💻 **Compute Engine VM** | Example infrastructure deployed from Terraform          |
| 🔐 **IAM Control**       | Ensures security and controlled access                  |
| 📈 **Scalability**       | Ready for multi-user, multi-environment Terraform usage |

