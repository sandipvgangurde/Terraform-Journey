# üß± SOP: Terraform State File Operations

---

## üéØ Objective

To define standard procedures for managing Terraform state files, including remote storage, locking, recovery, and version control, ensuring consistent, secure, and collaborative infrastructure management.

---

## üß© Scope

This SOP applies to all Terraform engineers working with **Google Cloud Platform (GCP)**, **AWS**, or other cloud providers, when using **remote backends** for state storage.

---

## üîπ Key Concepts

| Concept          | Description                                     | Benefit                                              |
| ---------------- | ----------------------------------------------- | ---------------------------------------------------- |
| Local State File | `terraform.tfstate` stored locally              | Quick access but not safe for teams                  |
| Remote State     | Store state in GCS, S3, or Terraform Cloud      | Enables collaboration, backup, and CI/CD integration |
| State Locking    | Prevents concurrent `terraform apply` or `plan` | Avoids state corruption                              |
| State Versioning | Keep historical versions of state               | Rollback in case of accidental changes               |
| State Operations | Import, Move, or Remove resources               | Maintain clean, accurate state                       |

---

## ‚öôÔ∏è Standard Procedures

### **1. Configure Remote Backend**

1. Choose a backend (e.g., GCS for GCP, S3 for AWS).
2. Enable **bucket versioning** (GCS) or **object versioning** (S3).
3. Add backend configuration in `main.tf`:

```hcl
terraform {
  backend "gcs" {
    bucket = "my-tf-state-bucket"
    prefix = "terraform/state"
  }
}
```

4. Initialize backend:

```bash
terraform init -migrate-state
```

‚úÖ Ensures state is migrated safely from local to remote.

---

### **2. Enable State Locking**

Terraform automatically locks the state file when using remote backends like GCS.

**Steps to ensure proper locking:**

1. Confirm bucket has **versioning enabled**.
2. Run `terraform apply` ‚Äî Terraform creates a `.tflock` file in the backend.
3. To test locking:

   * Run `terraform apply` in multiple terminals simultaneously.
   * The second terminal should receive an error about the lock.
4. To manually remove a stale lock (only if no active operations):

```bash
gsutil rm gs://my-tf-state-bucket/terraform/state/default.tflock
```

‚úÖ Prevents concurrent modifications and state corruption.

---

### **3. State File Operations**

#### a. Import Resource into State

```bash
terraform import google_compute_instance.vm_instance vm-12345
```

* Adds an existing cloud resource to Terraform state without creating it.

#### b. Move Resource Between Modules

```bash
terraform state mv module.old.google_compute_instance.vm module.new.google_compute_instance.vm
```

* Reorganizes state for modularized Terraform code.

#### c. Remove Resource from State

```bash
terraform state rm google_compute_instance.vm_instance
```

* Deletes resource entry from state without destroying the actual resource.

---

### **4. Backup and Version Control**

* Remote backend with versioning ensures automatic backup of every state change.
* To roll back to a previous state:

```bash
gsutil cp gs://my-tf-state-bucket/terraform/state/default.tfstate#<version_number> ./terraform.tfstate
```

* Confirm rollback using `terraform plan`.

---

### **5. Best Practices**

1. Never edit the state file manually.
2. Always use remote backend for team collaboration.
3. Enable **state locking** to prevent multiple concurrent operations.
4. Regularly monitor bucket versioning and clean up old locks.
5. Use separate state files for different environments (dev, staging, prod).
6. Ensure service accounts have proper IAM permissions:

   * `roles/storage.admin` or `roles/storage.objectAdmin` for GCS

---

### **6. Troubleshooting Common Errors**

| Error                               | Cause                                      | Solution                                            |
| ----------------------------------- | ------------------------------------------ | --------------------------------------------------- |
| `Error acquiring the state lock`    | Another Terraform operation is in progress | Wait for completion or remove stale lock if safe    |
| `State file not found`              | Backend misconfiguration or deleted bucket | Check backend config and bucket existence           |
| `Concurrent modifications detected` | Multiple users applying at the same time   | Enable state locking and coordinate team operations |

---

### **7. Cleanup Procedure**

* When decommissioning infrastructure:

```bash
terraform destroy -auto-approve
```

* Remote backend will remove `.tflock` and all state files if configured with `force_destroy = true` (GCS).

---

## üèÅ Expected Outcome

1. State files are securely stored in a remote backend.
2. Teams can safely collaborate using Terraform.
3. Resources can be imported, moved, or removed from state safely.
4. Rollback and recovery are possible using versioned state.
5. State locking prevents corruption and ensures operational safety.

---
