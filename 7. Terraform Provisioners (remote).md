# 🧩 **SOP: Terraform Provisioners — Automate Configuration Inside Resources** ⚙️🖥️

---

## 🎯 **Goal**

By the end of this SOP, you’ll:
✅ Understand what Terraform **provisioners** are
✅ Use `remote-exec` and `file` provisioners with **AWS EC2**
✅ Automate post-deployment setup (like installing Nginx, copying files, etc.)
✅ Learn **best practices** for safe and reliable automation

---

## 🧠 **What Are Provisioners?**

Provisioners are Terraform’s way of **running scripts or commands inside your resources** after they are created.

Think of them like:

> “Hey Terraform, after you create this EC2 instance, run these commands to configure it.”

---

## ⚙️ **Types of Provisioners**

| 🔢  | Provisioner Type  | Description                                           | Example Use Case                       |
| --- | ----------------- | ----------------------------------------------------- | -------------------------------------- |
| 1️⃣ | **`remote-exec`** | Runs commands over SSH on the remote VM               | Install Nginx, start services          |
| 2️⃣ | **`file`**        | Copies files from local machine to remote instance    | Upload configuration files             |
| 3️⃣ | **`local-exec`**  | Runs command locally (on your machine) after creation | Notify Slack, trigger Ansible playbook |

---

## 🪜 **Step-by-Step: Using Provisioners in Terraform**

---

### 🥇 Step 1: Setup Folder 📁

```bash
mkdir terraform-provisioner-demo
cd terraform-provisioner-demo
```

---

### 🥈 Step 2: Create `provider.tf` ☁️

```hcl
provider "aws" {
  region = "ap-south-1"
}
```

---

### 🥉 Step 3: Create EC2 Instance with Provisioner `ec2.tf` 🖥️

```hcl
resource "aws_instance" "web" {
  ami           = "ami-0dee22c13ea7a9a67"   # Ubuntu 22.04 (Mumbai)
  instance_type = "t2.micro"
  key_name      = "my-keypair"


  # Run remote commands (install Nginx)
  provisioner "remote-exec" {
    inline = [
      "sudo apt update -y",
      "sudo apt install nginx -y",
      "sudo systemctl start nginx",
      "sudo systemctl enable nginx"
    ]
  }

  connection {
    type        = "ssh"
    user        = "ubuntu"
    private_key = file("~/.ssh/my-keypair.pem")
    host        = self.public_ip
  }

  tags = {
    Name = "Terraform-Provisioner-Demo"
  }
}
```

---

### 🏗️ Step 4: Initialize, Plan & Apply Terraform 💥

```bash
terraform init
terraform plan
terraform apply -auto-approve
```

✅ Terraform will:

1. Create EC2
2. Copy your `index.html` file
3. Install and start Nginx inside the instance

---

### 🔍 Step 5: Verify in AWS Console 🌍

* Go to **EC2 → Instances**
* Copy the **Public IPv4 address**
* Open in browser:
  👉 `http://<your-public-ip>`

You’ll see:
**“Welcome to Terraform Provisioner Demo 🚀”**

---

### 🧩 Step 7: Add Outputs (Optional but Recommended)

```hcl
output "ec2_public_ip" {
  value = aws_instance.web.public_ip
}

output "instance_id" {
  value = aws_instance.web.id
}
```

✅ Run:

```bash
terraform output
```

📦 Output example:

```
ec2_public_ip = "3.110.22.45"
instance_id   = "i-0ab1234def5678gh"
```

---

### 💣 Step 8: Destroy Resources After Testing 🧹

```bash
terraform destroy -auto-approve
```

✅ Cleans up instance and all related state.

---

## 🔐 **Best Practices (DevOps-Level)**

| ⚙️ Practice                            | 💡 Explanation                                                         |
| -------------------------------------- | ---------------------------------------------------------------------- |
| Avoid heavy use of provisioners        | Use configuration management tools like **Ansible** for complex setups |
| Always use `connection` block securely | Store keys in a safe place, never hardcode them                        |
| Use `local-exec` for pipeline triggers | For CI/CD notifications or Ansible triggers                            |
| Keep scripts idempotent                | Ensure re-runs don’t break your infra                                  |
| Log provisioner actions                | Add output redirection for better debugging                            |

---

## 🧾 **Summary Table**

| Step | File / Command    | Description        | Result                      |
| ---- | ----------------- | ------------------ | --------------------------- |
| 🥇   | `provider.tf`     | AWS provider setup | Defines cloud provider      |
| 🥉   | `ec2.tf`          | EC2 + provisioners | Deploys & configures VM     |
| ⚙️   | `terraform apply` | Execute            | Runs provisioning steps     |
| 🔍   | Browser check     | Verify             | Access webpage on public IP |

---

## 💡 **Real-World DevOps Use Case**

In production:

* Use **provisioners** for quick, single-run setups (e.g., temporary scripts).
* For full automation → integrate **Terraform + Ansible + Jenkins** combo.

---

## 🚀 **End Result**

✅ EC2 instance is created
✅ Nginx auto-installed
✅ Webpage served immediately
✅ Infrastructure fully automated 🎯

---
