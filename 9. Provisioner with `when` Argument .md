## ğŸ§¾ **SOP: Terraform Provisioner with `when` Argument (remote-exec)**

---
Terraform Provisioner Flow (for both local-exec & remote-exec)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
         Terraform Provisioner Flow
        
      (for both local-exec & remote-exec)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     terraform init    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   terraform apply     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
             (1) Create Resources
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Execute Resource Phase     â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚  local-exec â†’ run command  â”‚
            â”‚     on Terraform host      â”‚
            â”‚  remote-exec â†’ connect and â”‚
            â”‚     run inside instance    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
             (2) Validate / Configure
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   terraform destroy   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”€â”
            â”‚  Destroy Resource Phase     â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”¤
            â”‚  Execute destroy provisionerâ”‚
            â”‚  â†’ run cleanup commands     â”‚
            â”‚  â†’ delete resource          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€------â”˜
                       â”‚
             (3) destroy Resources

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§  Summary:
terraform apply â†’ create resource â†’ exec resource â†’ run commands  
terraform destroy â†’ exec resource â†’ run destroy commands â†’ cleanup  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


ğŸ” Quick Breakdown:

local-exec â†’ Runs a command on your local machine (where Terraform runs).

remote-exec â†’ Connects to the created instance (VM) and runs a command inside it.

Both execute after the resource is created, before Terraform finishes apply.

On destroy, cleanup provisioners can also trigger (if defined).
### ğŸ” **Objective**

This SOP explains how to use the **`remote-exec` provisioner** in Terraform to automatically configure an **AWS EC2 instance** during **creation** ğŸ†• and perform cleanup actions during **destruction** ğŸ—‘ï¸ â€” using the **`when` argument**.

---

### âš™ï¸ **Environment Setup**

| Component          | Description                                           |
| ------------------ | ----------------------------------------------------- |
| **Provider**       | AWS (`region = ap-southeast-1`)                       |
| **AMI**            | `ami-0ffd8e96d1336b6ac` (Amazon Linux 2023)           |
| **Instance Type**  | `t3.micro`                                            |
| **Key Pair**       | `mykeypair.pem`                                       |
| **Security Group** | Allows inbound SSH (port 22) and all outbound traffic |

---

### ğŸ§© **Terraform Code Overview**

#### ğŸ“„ `provi.tf`

```hcl
provider "aws" {
  region = "ap-southeast-1"
}

# ğŸ”’ Step 1: Create a security group for SSH access
resource "aws_security_group" "allow_ssh" {
  name        = "allow_ssh"
  description = "Allow SSH inbound traffic"

  ingress {
    description = "SSH into VPC"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "Outbound Allowed"
    from_port   = 0
    to_port     = 65535
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# ğŸ’» Step 2: Launch an EC2 instance and install Nginx
resource "aws_instance" "myec2" {
  ami           = "ami-0ffd8e96d1336b6ac"
  instance_type = "t3.micro"
  key_name      = "mykeypair"
  vpc_security_group_ids = [aws_security_group.allow_ssh.id]

  # ğŸš€ Remote Provisioner during creation
  provisioner "remote-exec" {
    inline = [
      "sudo yum update -y",
      "sudo yum install nginx -y",
      "sudo systemctl start nginx",
      "sudo systemctl enable nginx"
    ]
  }

  # ğŸ§¹ Remote Provisioner during destruction
  provisioner "remote-exec" {
    when = destroy
    inline = [
      "sudo yum -y remove nginx"
    ]
  }

  # ğŸ”‘ Connection block for SSH
  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("./mykeypair.pem")
    host        = self.public_ip
  }
}
```

---

### ğŸ§  **Concept Breakdown**

| Term                   | Meaning                                                                  | Example                                               |
| ---------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------- |
| **Provisioner**        | Executes commands inside a resource after creation or before destruction | Installing Nginx or removing it                       |
| **`remote-exec`**      | Runs commands on a remote machine via SSH                                | Used to configure EC2                                 |
| **`inline`**           | List of shell commands to execute                                        | `["sudo yum update -y", "sudo yum install nginx -y"]` |
| **`connection` block** | Defines how Terraform connects to the instance                           | SSH via key pair                                      |
| **`when = destroy`**   | Triggers provisioner **only when the resource is destroyed**             | Used for cleanup tasks like uninstalling Nginx        |

---

### âš¡ **Execution Flow**

#### ğŸ› ï¸ Step 1: Apply Configuration

```bash
terraform apply --auto-approve
```

âœ… Terraform creates:

* Security group â†’ allows SSH
* EC2 instance â†’ runs provisioner (installs and enables Nginx)

â±ï¸ Time Taken: ~60 seconds

ğŸ§¾ Output shows successful SSH connection and package installation logs (Nginx installed).

---

#### ğŸ—‘ï¸ Step 2: Destroy Configuration

```bash
terraform destroy --auto-approve
```

âœ… Terraform:

* Connects again to the instance before termination
* Executes the **destroy provisioner** (`yum remove nginx`)
* Then deletes the instance and security group

â±ï¸ Time Taken: ~50 seconds

---

### ğŸ§° **Use Case**

| Scenario                 | Example                                                                                                |
| ------------------------ | ------------------------------------------------------------------------------------------------------ |
| **Auto Configuration**   | Install required software (e.g., Nginx, Docker, monitoring agents) immediately after instance creation |
| **Cleanup Tasks**        | Stop services, delete temp files, or uninstall packages before destroying instances                    |
| **Testing Environments** | Automate setup & teardown of servers for integration or QA testing                                     |

---

### âš ï¸ **Best Practices**

âœ… Always use **provisioners as a last resort** â€” prefer **cloud-init, user_data**, or **Ansible** for configuration.
âœ… Keep commands **idempotent** (safe to run multiple times).
âœ… Avoid long-running commands â€” Terraform may timeout.
âœ… Use **`connection` block** properly â€” wrong key or user causes SSH failure.
âœ… Never expose your `.pem` key in public repos.

---

### ğŸ“Š **Result Verification**

After apply:

```bash
curl http://<public-ip>
```

You should see the **Nginx default page** ğŸŸ¢

After destroy:

* Instance terminated âŒ
* Nginx removed before termination âœ…

---

### â±ï¸ **Total Timeline**

| Stage             | Duration | Description                          |
| ----------------- | -------- | ------------------------------------ |
| Terraform Apply   | ~1 min   | Instance creation + Nginx setup      |
| Terraform Destroy | ~50 sec  | Nginx removal + instance termination |

---

### ğŸ§© **Summary**

| Action                | Tool/Command        | Result                             |
| --------------------- | ------------------- | ---------------------------------- |
| Create EC2 + Nginx    | `terraform apply`   | Nginx installed & running          |
| Destroy EC2 + Cleanup | `terraform destroy` | Nginx removed & EC2 terminated     |
| Key Feature           | `when = destroy`    | Executes only on resource deletion |

---

### ğŸ¯ **End Goal**

âœ… Understand how **Terraform provisioners** automate both **setup** and **cleanup**
âœ… Learn to control execution timing using `when = destroy`
âœ… Achieve full lifecycle automation from **creation â†’ configuration â†’ destruction**


---
