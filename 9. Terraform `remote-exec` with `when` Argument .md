## 🧾 **SOP: Terraform Provisioner with `when` Argument (remote-exec)**

---
Terraform Provisioner Flow (for both local-exec & remote-exec)
──────────────────────────────────────────────────────────────────────
        
         Terraform Provisioner Flow
        
      (for both local-exec & remote-exec)
───────────────────────────────────────────────────────────────────────

            ┌───────────────────────┐
            │     terraform init    │
            └──────────┬────────────┘
                       │
                       ▼
            ┌───────────────────────┐
            │   terraform apply     │
            └──────────┬────────────┘
                       │
             (1) Create Resources
                       │
                       ▼
            ┌────────────────────────────┐
            │  Execute Resource Phase     │
            ├────────────────────────────┤
            │  local-exec → run command  │
            │     on Terraform host      │
            │  remote-exec → connect and │
            │     run inside instance    │
            └──────────┬─────────────────┘
                       │
                       ▼
             (2) Validate / Configure
                       │
                       ▼
            ┌───────────────────────┐
            │   terraform destroy   │
            └──────────┬────────────┘
                       │
                       ▼
            ┌───────────────────────────-─┐
            │  Destroy Resource Phase     │
            ├────────────────────────────-┤
            │  Execute destroy provisioner│
            │  → run cleanup commands     │
            │  → delete resource          │
            └──────────┬────────────------┘
                       │
             (3) destroy Resources

──────────────────────────────────────────────
🧠 Summary:
terraform apply → create resource → exec resource → run commands  
terraform destroy → exec resource → run destroy commands → cleanup  
──────────────────────────────────────────────


🔍 Quick Breakdown:

local-exec → Runs a command on your local machine (where Terraform runs).

remote-exec → Connects to the created instance (VM) and runs a command inside it.

Both execute after the resource is created, before Terraform finishes apply.

On destroy, cleanup provisioners can also trigger (if defined).
### 🔍 **Objective**

This SOP explains how to use the **`remote-exec` provisioner** in Terraform to automatically configure an **AWS EC2 instance** during **creation** 🆕 and perform cleanup actions during **destruction** 🗑️ — using the **`when` argument**.

---

### ⚙️ **Environment Setup**

| Component          | Description                                           |
| ------------------ | ----------------------------------------------------- |
| **Provider**       | AWS (`region = ap-southeast-1`)                       |
| **AMI**            | `ami-0ffd8e96d1336b6ac` (Amazon Linux 2023)           |
| **Instance Type**  | `t3.micro`                                            |
| **Key Pair**       | `mykeypair.pem`                                       |
| **Security Group** | Allows inbound SSH (port 22) and all outbound traffic |

---

### 🧩 **Terraform Code Overview**

#### 📄 `provi.tf`

```hcl
provider "aws" {
  region = "ap-southeast-1"
}

# 🔒 Step 1: Create a security group for SSH access
resource "aws_security_group" "allow_ssh" {
  name        = "allow_ssh"
  description = "Allow SSH inbound traffic"

  ingress {
    description = "SSH into VPC"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    description = "Outbound Allowed"
    from_port   = 0
    to_port     = 65535
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# 💻 Step 2: Launch an EC2 instance and install Nginx
resource "aws_instance" "myec2" {
  ami           = "ami-0ffd8e96d1336b6ac"
  instance_type = "t3.micro"
  key_name      = "mykeypair"
  vpc_security_group_ids = [aws_security_group.allow_ssh.id]

  # 🚀 Remote Provisioner during creation
  provisioner "remote-exec" {
    inline = [
      "sudo yum update -y",
      "sudo yum install nginx -y",
      "sudo systemctl start nginx",
      "sudo systemctl enable nginx"
    ]
  }

  # 🧹 Remote Provisioner during destruction
  provisioner "remote-exec" {
    when = destroy
    inline = [
      "sudo yum -y remove nginx"
    ]
  }

  # 🔑 Connection block for SSH
  connection {
    type        = "ssh"
    user        = "ec2-user"
    private_key = file("./mykeypair.pem")
    host        = self.public_ip
  }
}
```

---

### 🧠 **Concept Breakdown**

| Term                   | Meaning                                                                  | Example                                               |
| ---------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------- |
| **Provisioner**        | Executes commands inside a resource after creation or before destruction | Installing Nginx or removing it                       |
| **`remote-exec`**      | Runs commands on a remote machine via SSH                                | Used to configure EC2                                 |
| **`inline`**           | List of shell commands to execute                                        | `["sudo yum update -y", "sudo yum install nginx -y"]` |
| **`connection` block** | Defines how Terraform connects to the instance                           | SSH via key pair                                      |
| **`when = destroy`**   | Triggers provisioner **only when the resource is destroyed**             | Used for cleanup tasks like uninstalling Nginx        |

---

### ⚡ **Execution Flow**

#### 🛠️ Step 1: Apply Configuration

```bash
terraform apply --auto-approve
```

✅ Terraform creates:

* Security group → allows SSH
* EC2 instance → runs provisioner (installs and enables Nginx)

⏱️ Time Taken: ~60 seconds

🧾 Output shows successful SSH connection and package installation logs (Nginx installed).

---

#### 🗑️ Step 2: Destroy Configuration

```bash
terraform destroy --auto-approve
```

✅ Terraform:

* Connects again to the instance before termination
* Executes the **destroy provisioner** (`yum remove nginx`)
* Then deletes the instance and security group

⏱️ Time Taken: ~50 seconds

---

### 🧰 **Use Case**

| Scenario                 | Example                                                                                                |
| ------------------------ | ------------------------------------------------------------------------------------------------------ |
| **Auto Configuration**   | Install required software (e.g., Nginx, Docker, monitoring agents) immediately after instance creation |
| **Cleanup Tasks**        | Stop services, delete temp files, or uninstall packages before destroying instances                    |
| **Testing Environments** | Automate setup & teardown of servers for integration or QA testing                                     |

---

### ⚠️ **Best Practices**

✅ Always use **provisioners as a last resort** — prefer **cloud-init, user_data**, or **Ansible** for configuration.
✅ Keep commands **idempotent** (safe to run multiple times).
✅ Avoid long-running commands — Terraform may timeout.
✅ Use **`connection` block** properly — wrong key or user causes SSH failure.
✅ Never expose your `.pem` key in public repos.

---

### 📊 **Result Verification**

After apply:

```bash
curl http://<public-ip>
```

You should see the **Nginx default page** 🟢

After destroy:

* Instance terminated ❌
* Nginx removed before termination ✅

---

### ⏱️ **Total Timeline**

| Stage             | Duration | Description                          |
| ----------------- | -------- | ------------------------------------ |
| Terraform Apply   | ~1 min   | Instance creation + Nginx setup      |
| Terraform Destroy | ~50 sec  | Nginx removal + instance termination |

---

### 🧩 **Summary**

| Action                | Tool/Command        | Result                             |
| --------------------- | ------------------- | ---------------------------------- |
| Create EC2 + Nginx    | `terraform apply`   | Nginx installed & running          |
| Destroy EC2 + Cleanup | `terraform destroy` | Nginx removed & EC2 terminated     |
| Key Feature           | `when = destroy`    | Executes only on resource deletion |

---

### 🎯 **End Goal**

✅ Understand how **Terraform provisioners** automate both **setup** and **cleanup**
✅ Learn to control execution timing using `when = destroy`
✅ Achieve full lifecycle automation from **creation → configuration → destruction**


---
